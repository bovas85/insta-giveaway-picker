<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Giveaway Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .log-line { font-family: 'Courier New', monospace; font-size: 0.9rem; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center py-10">

    <div class="w-full max-w-3xl px-4">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-yellow-500">
                Instagram Giveaway Analyzer
            </h1>
            <p class="text-gray-400 mt-2">Find the winner who follows the rules.</p>
        </header>

        <!-- Input Form -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg mb-8 border border-gray-700">
            <div class="mb-4">
                <label class="block text-gray-400 text-sm font-bold mb-2">Access Code (If required)</label>
                <div class="flex gap-2">
                    <input id="accessCode" type="password" placeholder="Secret Code" 
                        class="w-full bg-gray-700 text-white border border-gray-600 rounded px-3 py-3 focus:outline-none focus:border-pink-500 transition">
                    <button onclick="verifyAdmin()" class="bg-gray-700 hover:bg-gray-600 border border-gray-600 text-gray-300 font-bold py-3 px-4 rounded transition" title="Unlock Admin Tools">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-gray-400 text-sm font-bold mb-2">Post URL</label>
                <input id="postUrl" type="text" placeholder="https://www.instagram.com/p/..." 
                    class="w-full bg-gray-700 text-white border border-gray-600 rounded px-3 py-3 focus:outline-none focus:border-pink-500 transition">
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-400 text-sm font-bold mb-2">Competitors (Comma Separated)</label>
                <input id="competitors" type="text" placeholder="brand1, brand2" 
                    class="w-full bg-gray-700 text-white border border-gray-600 rounded px-3 py-3 focus:outline-none focus:border-pink-500 transition">
            </div>

            <div class="flex flex-col gap-4">
                <div class="flex gap-4">
                    <button id="startBtn" onclick="startAnalysis()" 
                        class="flex-1 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold py-3 px-4 rounded-lg transition transform active:scale-95">
                        Start Analysis
                    </button>
                </div>

                <!-- Auth Status Indicators -->
                <div id="authStatus" class="flex gap-4 justify-center text-sm font-semibold">
                    <span id="apiStatus" class="hidden text-green-400 border border-green-500/50 px-3 py-1 rounded bg-green-500/10">
                        ‚úÖ Graph API Connected
                    </span>
                    <span id="browserStatus" class="hidden text-green-400 border border-green-500/50 px-3 py-1 rounded bg-green-500/10">
                        ‚úÖ Browser Session Ready
                    </span>
                </div>

                <!-- Login Buttons (Hidden if connected) -->
                <div id="loginButtons" class="hidden flex gap-4">
                    <button id="browserLoginBtn" onclick="openLogin()" 
                        class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition border border-gray-600">
                        Browser Login (Required)
                    </button>
                    <a id="apiLoginBtn" href="/auth/instagram" target="_blank"
                        class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg transition text-center block">
                        API Login (Optional - Faster)
                    </a>
                </div>
                <div id="reauthHint" class="hidden text-center text-xs text-gray-500 cursor-pointer hover:text-gray-300 underline" onclick="showLoginButtons()">
                    Need to switch accounts? Show Login Options
                </div>
            </div>
        </div>

        <!-- Graph API Info (Hidden if connected) -->
        <div id="apiInfo" class="hidden bg-blue-900/30 border border-blue-500/50 rounded-xl p-4 mb-8 text-sm">
            <h3 class="font-bold text-blue-400 mb-1">Graph API Mode (Optional):</h3>
            <p class="text-gray-300">Use <strong>API Login</strong> for ultra-fast comment fetching (requires a Business Account). If skipped, the tool will just use the browser to scrape comments.</p>
        </div>

        <!-- Winner Reveal -->
        <div id="winnerCard" class="hidden text-center bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl p-8 shadow-2xl text-black transform transition-all duration-500 scale-95 opacity-0 mb-8">
            <h2 class="text-2xl font-bold mb-2">üèÜ WE HAVE A WINNER! üèÜ</h2>
            <div class="text-5xl font-extrabold my-4" id="winnerName">@username</div>
            <a id="winnerLink" href="#" target="_blank" class="inline-block bg-black text-white px-6 py-2 rounded-full font-bold hover:bg-gray-800 transition">
                View Profile
            </a>
            <div class="mt-4 text-sm font-semibold opacity-75">
                Qualified Candidates: <span id="qualifiedCount">0</span> ‚Ä¢ Time: <span id="timeTaken">0s</span>
            </div>
        </div>

        <!-- Progress / Logs -->
        <div id="logContainer" class="bg-black rounded-xl p-6 shadow-lg border border-gray-800 h-96 overflow-y-auto mb-8 hidden">
            <div id="logs" class="flex flex-col gap-1 text-green-400"></div>
        </div>
    </div>

    <script>
        const socket = io();
        const logsDiv = document.getElementById('logs');
        const logContainer = document.getElementById('logContainer');
        const winnerCard = document.getElementById('winnerCard');
        const startBtn = document.getElementById('startBtn');

        // Load saved values
        window.onload = () => {
            const savedUrl = localStorage.getItem('postUrl');
            const savedComps = localStorage.getItem('competitors');
            // Removed accessCode auto-load for security
            if (savedUrl) document.getElementById('postUrl').value = savedUrl;
            if (savedComps) document.getElementById('competitors').value = savedComps;
        };

        socket.on('log', (msg) => {
            logContainer.classList.remove('hidden');
            const div = document.createElement('div');
            div.className = 'log-line';
            div.innerText = msg;
            logsDiv.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        });

        socket.on('auth-status', (status) => {
            const loginBtns = document.getElementById('loginButtons');
            const apiInfo = document.getElementById('apiInfo');
            const reauthHint = document.getElementById('reauthHint');
            
            let allReady = true;

            if (status.apiReady) {
                document.getElementById('apiStatus').classList.remove('hidden');
                document.getElementById('apiLoginBtn').classList.add('hidden');
                apiInfo.classList.add('hidden');
            } else {
                allReady = false;
            }

            if (status.browserReady) {
                document.getElementById('browserStatus').classList.remove('hidden');
                document.getElementById('browserLoginBtn').classList.add('hidden');
            } else {
                // If browser not ready, we might want to keep the button visible
                // But user says "hide and only show if fails".
                // We'll hide it if API is ready (since API handles comments), 
                // but strictly speaking browser login is needed for follows.
                // Let's keep it visible if NOT ready.
                allReady = false;
            }

            // If BOTH are ready, hide the container entirely
            if (status.apiReady && status.browserReady) {
                loginBtns.classList.add('hidden');
                reauthHint.classList.add('hidden'); // Always hide hint until unlocked
            } else {
                // If something is missing, we usually show buttons, 
                // BUT user wants them hidden by default for public.
                loginBtns.classList.add('hidden');
                reauthHint.classList.add('hidden');
            }
        });

        function verifyAdmin() {
            const code = document.getElementById('accessCode').value;
            socket.emit('verify-access-code', code);
        }

        socket.on('admin-access-granted', () => {
            showLoginButtons();
            // Also show the apiInfo if API is missing
            document.getElementById('apiInfo').classList.remove('hidden');
        });

        function showLoginButtons() {
            document.getElementById('loginButtons').classList.remove('hidden');
            document.getElementById('apiLoginBtn').classList.remove('hidden');
            document.getElementById('browserLoginBtn').classList.remove('hidden');
        }

        socket.on('result', (data) => {
            if (data.error) {
                // If it's just an error, we enable the button again but don't show the alert if it's an access denied from log
                // But the socket.emit("result") from server handles error object.
                // We'll just alert it.
                // alert(data.error); 
                // Using log area for errors is better UX than alert for this specific case, but alert is fine for now.
                startBtn.disabled = false;
                startBtn.innerText = "Start Analysis";
                return;
            }

            // Show Winner
            document.getElementById('winnerName').innerText = "@" + data.winner;
            document.getElementById('winnerLink').href = data.profile;
            document.getElementById('qualifiedCount').innerText = data.qualified.length;
            
            const mins = Math.floor(data.duration / 60);
            const secs = data.duration % 60;
            const timeStr = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
            document.getElementById('timeTaken').innerText = timeStr;
            
            winnerCard.classList.remove('hidden');
            // Trigger animation
            setTimeout(() => {
                winnerCard.classList.remove('scale-95', 'opacity-0');
                winnerCard.classList.add('scale-100', 'opacity-100');
            }, 50);

            startBtn.disabled = false;
            startBtn.innerText = "Run Again";
        });

        function startAnalysis() {
            const postUrl = document.getElementById('postUrl').value;
            const competitors = document.getElementById('competitors').value;
            const accessCode = document.getElementById('accessCode').value;

            if(!postUrl || !competitors) {
                alert("Please fill in all fields");
                return;
            }

            // Save to local storage
            localStorage.setItem('postUrl', postUrl);
            localStorage.setItem('competitors', competitors);
            // localStorage.setItem('accessCode', accessCode); // Removed for security

            // Reset UI
            logsDiv.innerHTML = '';
            winnerCard.classList.add('hidden', 'scale-95', 'opacity-0');
            startBtn.disabled = true;
            startBtn.innerText = "Running...";

            socket.emit('start-analysis', { postUrl, competitors, accessCode });
        }

        function openLogin() {
            logContainer.classList.remove('hidden');
            socket.emit('open-login');
        }
    </script>
</body>
</html>
